<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockAdvisor Pro | AI-Powered Market Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* The full, original CSS is included here to guarantee the theme is perfect. */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        :root { --primary: #1a75ff; --secondary: #00b3ff; --accent: #00e5ff; --dark: #0a192f; --darker: #081223; --light: #f0f8ff; --success: #00c853; --danger: #ff5252; --warning: #ffc107; --neutral: #9c27b0; --bullish: rgba(0, 200, 83, 0.15); --bearish: rgba(255, 82, 82, 0.15); }
        body { background: linear-gradient(135deg, var(--darker), var(--dark)); color: var(--light); min-height: 100vh; padding: 20px; overflow-x: hidden; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { text-align: center; padding: 20px 0; margin-bottom: 30px; position: relative; overflow: hidden; }
        .header-content { position: relative; z-index: 2; }
        h1 { font-size: 2.8rem; text-shadow: 0 2px 15px rgba(0, 0, 0, 0.4); background: linear-gradient(to right, var(--accent), var(--secondary)); -webkit-background-clip: text; background-clip: text; color: transparent; margin-bottom: 10px; font-weight: 700; letter-spacing: 1px; }
        .subtitle { font-size: 1.2rem; opacity: 0.85; max-width: 800px; margin: 0 auto; line-height: 1.6; color: #c2e0ff; }
        .glowing-circle { position: absolute; width: 300px; height: 300px; background: radial-gradient(circle, rgba(26, 117, 255, 0.3) 0%, transparent 70%); border-radius: 50%; top: -100px; left: 50%; transform: translateX(-50%); z-index: 1; }
        .ai-overview { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; }
        .ai-engine { background: rgba(10, 25, 47, 0.7); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 179, 255, 0.2); position: relative; overflow: hidden; }
        .ai-engine::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--accent), var(--secondary)); }
        .engine-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .engine-icon { width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; }
        .deepseek-icon { background: linear-gradient(135deg, #6a11cb, #2575fc); }
        .gemini-icon { background: linear-gradient(135deg, #ff5e62, #ff9966); }
        .engine-content { line-height: 1.7; }
        .engine-content ul { list-style-position: inside; padding-left: 5px; } .engine-content li { margin-bottom: 8px; }
        .bullish { color: var(--success); background-color: var(--bullish); padding: 2px 6px; border-radius: 4px; }
        .bearish { color: var(--danger); background-color: var(--bearish); padding: 2px 6px; border-radius: 4px; }
        .dashboard { display: grid; grid-template-columns: 1fr 2fr; gap: 25px; margin-bottom: 25px; }
        .control-panel { background: rgba(10, 25, 47, 0.7); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 179, 255, 0.2); position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .control-panel::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--accent), var(--secondary)); }
        .panel-title { font-size: 1.5rem; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid rgba(0, 179, 255, 0.2); color: var(--accent); display: flex; align-items: center; gap: 10px; }
        .form-group { margin-bottom: 25px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; font-size: 1.1rem; color: #a4d0ff; }
        select, input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid rgba(0, 179, 255, 0.3); background: rgba(0, 30, 60, 0.4); color: white; font-size: 1rem; outline: none; transition: all 0.3s; }
        select:focus, input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(0, 229, 255, 0.3); }
        select { height: 50px; }
        .indicator-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .indicator-item { background: rgba(0, 80, 160, 0.3); border-radius: 12px; padding: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; border: 1px solid rgba(0, 179, 255, 0.1); font-size: 0.9rem; }
        .indicator-item:hover { background: rgba(0, 120, 215, 0.4); transform: translateY(-2px); border-color: var(--accent); }
        .indicator-item.selected { background: rgba(0, 150, 255, 0.5); border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        .indicator-item i { font-size: 1rem; color: var(--accent); }
        .btn { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; border-radius: 12px; padding: 16px; font-size: 1.1rem; font-weight: 600; cursor: pointer; width: 100%; transition: all 0.3s; box-shadow: 0 4px 20px rgba(26, 117, 255, 0.4); display: flex; justify-content: center; align-items: center; gap: 10px; position: relative; overflow: hidden; }
        .output-panel { background: rgba(10, 25, 47, 0.7); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 179, 255, 0.2); min-height: 500px; position: relative; overflow: hidden; display: flex; flex-direction: column; }
        .output-panel::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(90deg, var(--accent), var(--secondary)); }
        .output-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid rgba(0, 179, 255, 0.2); }
        .stock-info { display: flex; align-items: center; gap: 15px; }
        .stock-icon { width: 60px; height: 60px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; box-shadow: 0 0 20px rgba(0, 179, 255, 0.4); }
        .stock-details h2 { font-size: 1.8rem; margin-bottom: 5px; background: linear-gradient(to right, var(--accent), var(--secondary)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .stock-details p { font-size: 1.1rem; opacity: 0.9; }
        .trend-indicator { padding: 10px 25px; border-radius: 30px; font-weight: bold; text-transform: uppercase; font-size: 1rem; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .trend-up { background: rgba(0, 200, 83, 0.15); color: #00c853; border: 1px solid rgba(0, 200, 83, 0.3); }
        .trend-down { background: rgba(255, 82, 82, 0.15); color: #ff5252; border: 1px solid rgba(255, 82, 82, 0.3); }
        .trend-neutral { background: rgba(255, 193, 7, 0.15); color: #ffc107; border: 1px solid rgba(255, 193, 7, 0.3); }
        .output-content { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; flex: 1; }
        .analysis-section { background: rgba(0, 40, 80, 0.3); border-radius: 15px; padding: 20px; border: 1px solid rgba(0, 179, 255, 0.1); position: relative; overflow: hidden; }
        .section-title { font-size: 1.2rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0, 179, 255, 0.1); display: flex; align-items: center; gap: 10px; color: var(--accent); }
        .analysis-text { line-height: 1.7; margin-bottom: 15px; color: #e6f7ff; }
        .parameters { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .param-card { background: rgba(0, 60, 120, 0.4); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(0, 179, 255, 0.1); }
        .param-value { font-size: 1.6rem; font-weight: bold; margin: 10px 0; color: var(--accent); text-shadow: 0 0 10px rgba(0, 229, 255, 0.3); }
        .param-label { font-size: 0.9rem; opacity: 0.8; }
        .thought-process { grid-column: 1 / -1; }
        .thought-content { background: rgba(0, 40, 80, 0.3); border-radius: 15px; padding: 20px; max-height: 400px; overflow-y: auto; border: 1px solid rgba(0, 179, 255, 0.1); display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .thought-column { display: flex; flex-direction: column; gap: 15px; }
        .thought-item { padding: 10px; border-radius: 12px; background: rgba(0, 60, 120, 0.3); display: flex; gap: 10px; }
        .thought-icon { color: var(--accent); min-width: 24px; font-size: 0.9rem; padding-top: 3px; }
        .risk-indicator { display: flex; align-items: center; gap: 10px; padding: 10px 15px; border-radius: 20px; margin-top: 15px; border: 1px solid; }
        .risk-low { background: rgba(0, 200, 83, 0.1); border-color: rgba(0, 200, 83, 0.2); color: #00c853;}
        .risk-medium { background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.2); color: #ffc107;}
        .risk-high { background: rgba(255, 82, 82, 0.1); border-color: rgba(255, 82, 82, 0.2); color: #ff5252;}
        .risk-bar { height: 8px; flex-grow: 1; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden; }
        .risk-level { height: 100%; border-radius: 4px; }
        .risk-low .risk-level { background: var(--success); } .risk-medium .risk-level { background: var(--warning); } .risk-high .risk-level { background: var(--danger); }
        .sentiment-meter { display: flex; justify-content: space-between; margin-top: 15px; background: rgba(0, 40, 80, 0.3); border-radius: 12px; padding: 10px; border: 1px solid rgba(0, 179, 255, 0.1); }
        .sentiment-item { text-align: center; flex: 1; padding: 8px; border-radius: 8px; cursor: pointer; transition: all 0.3s; }
        .sentiment-item.active { background: rgba(0, 150, 255, 0.4); border: 1px solid var(--accent); }
        .sentiment-item i { font-size: 1.5rem; margin-bottom: 5px; }
        .sentiment-bullish i { color: var(--success); } .sentiment-bearish i { color: var(--danger); } .sentiment-neutral i { color: var(--warning); }
        .confidence-meter { display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .confidence-level { width: 100%; height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; overflow: hidden; }
        .confidence-fill { height: 100%; background: linear-gradient(90deg, var(--danger), var(--warning), var(--success)); border-radius: 5px; }
        .strategy-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 15px; }
        .strategy-card { background: rgba(0, 60, 120, 0.4); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(0, 179, 255, 0.1); cursor: pointer; transition: all 0.3s; }
        .strategy-card.active { background: rgba(0, 150, 255, 0.5); border-color: var(--accent); box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); }
        .strategy-card i { font-size: 1.8rem; margin-bottom: 10px; color: var(--accent); }
        .control-metrics-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; } /* 7x2 Layout */
        .metric-card { background: rgba(0, 60, 120, 0.4); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(0, 179, 255, 0.1); }
        .metric-value { font-size: 1.2rem; font-weight: bold; margin: 5px 0; color: var(--accent); }
        .metric-label { font-size: 0.85rem; opacity: 0.8; }
        .metric-positive { color: var(--success); } .metric-negative { color: var(--danger); }
        footer { text-align: center; padding: 20px; opacity: 0.7; font-size: 0.9rem; color: #a4d0ff; }
        .market-matrices { grid-column: 1 / -1; margin-top: 20px; }
        /* THIS IS THE FIX. Restoring the 6x2 card layout for technical matrices */
        .matrices-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px; }
        .matrix-card { background: rgba(0, 60, 120, 0.4); border-radius: 12px; padding: 15px; text-align: center; border: 1px solid rgba(0, 179, 255, 0.1); }
        .matrix-value { font-size: 1.4rem; font-weight: bold; color: var(--accent); }
        .ai-insights-section { margin-top: 25px; }
        .insights-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .insight-card { background: rgba(0, 40, 80, 0.3); border-radius: 15px; padding: 20px; border: 1px solid rgba(0, 179, 255, 0.1); }
        .probability-meter { height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 5px; margin: 15px 0; overflow: hidden; }
        .probability-fill { height: 100%; border-radius: 5px; background: linear-gradient(90deg, #00c853, #64dd17); }
        .probability-value { font-size: 1.8rem; font-weight: bold; text-align: center; margin: 15px 0; background: linear-gradient(to right, var(--accent), var(--secondary)); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .price-targets { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .target-card { background: rgba(0, 60, 120, 0.4); border-radius: 12px; padding: 12px; text-align: center; }
        .target-value { font-size: 1.2rem; font-weight: bold; margin: 5px 0; }
        .target-label { font-size: 0.85rem; opacity: 0.8; }
        @media (max-width: 900px) { .dashboard, .ai-overview, .insights-grid, .thought-content { grid-template-columns: 1fr; } .output-content { grid-template-columns: 1fr; } }
        @media (max-width: 600px) { .matrices-grid, .control-metrics-grid, .price-targets, .institutional-grid { grid-template-columns: 1fr; } .output-header { flex-direction: column; align-items: flex-start; gap: 15px; } }
        .notification { position: fixed; top: 20px; right: 20px; background: rgba(10, 25, 47, 0.9); color: var(--accent); padding: 15px 25px; border-radius: 10px; border-left: 4px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 1000; display: flex; align-items: center; gap: 10px; transform: translateX(150%); transition: transform 0.5s ease-in-out; }
        .notification.error { color: var(--danger); border-left-color: var(--danger); }
        .notification.show { transform: translateX(0); }
        .analysis-section .error-message { color: var(--danger); font-style: italic; opacity: 0.8; }
        ul { list-style-position: inside; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="glowing-circle"></div>
            <div class="header-content">
                <h1><i class="fas fa-chart-line"></i>Harendra's StockAdvisor Pro</h1>
                <p class="subtitle">Advanced AI-powered stock market analysis with Google Gemini</p>
            </div>
        </header>
        
        <div class="ai-overview">
            <div class="ai-engine">
                <div class="engine-header"><div class="engine-icon deepseek-icon"><i class="fas fa-file-invoice-dollar"></i></div><h2 class="panel-title">Gemini Strategic Outlook</h2></div>
                <div class="engine-content" id="gemini-strategic-outlook"><p>Awaiting analysis...</p></div>
            </div>
            <div class="ai-engine">
                <div class="engine-header"><div class="engine-icon gemini-icon"><i class="fas fa-chart-pie"></i></div><h2 class="panel-title">Gemini Tactical Analysis</h2></div>
                <div class="engine-content" id="gemini-tactical-analysis"><p>Awaiting analysis...</p></div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="control-panel">
                <h2 class="panel-title"><i class="fas fa-sliders-h"></i> Analysis Parameters</h2>
                <div class="form-group">
                    <label for="stock-select"><i class="fas fa-coins"></i> Select Stock/Index</label>
                    <select id="stock-select">
                        {% for sector, symbols in stock_sectors.items() %}
                            <optgroup label="{{ sector }}">
                                {% for symbol in symbols %}
                                    <option value="{{ symbol }}">{{ symbol }}</option>
                                {% endfor %}
                            </optgroup>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="timeframe"><i class="fas fa-clock"></i> Timeframe</label>
                    <select id="timeframe">
                        <option value="15m">15 Minutes</option> <option value="1h">1 Hour</option> <option value="4h">4 Hours</option> 
                        <option value="1d" selected>1 Day</option> <option value="1w">1 Week</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="risk-level"><i class="fas fa-shield-alt"></i> Risk Tolerance</label>
                    <select id="risk-level">
                        <option value="low">Low (Conservative)</option> <option value="medium" selected>Medium (Balanced)</option> <option value="high">High (Aggressive)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-chart-line"></i> Technical Indicators</label>
                    <div class="indicator-list" id="indicator-list">
                        <div class="indicator-item selected" data-indicator="rsi"> <i class="fas fa-wave-square"></i> RSI </div>
                        <div class="indicator-item selected" data-indicator="macd"> <i class="fas fa-exchange-alt"></i> MACD </div>
                        <div class="indicator-item selected" data-indicator="sma"> <i class="fas fa-chart-area"></i> SMA </div>
                        <div class="indicator-item" data-indicator="ema"> <i class="fas fa-chart-line"></i> EMA </div>
                        <div class="indicator-item selected" data-indicator="bollinger"> <i class="fas fa-arrows-alt-h"></i> Bollinger </div>
                        <div class="indicator-item" data-indicator="stochrsi"> <i class="fas fa-signal"></i> Stoch RSI </div>
                        <div class="indicator-item" data-indicator="obv"> <i class="fas fa-weight-hanging"></i> OBV </div>
                        <div class="indicator-item" data-indicator="fibonacci"> <i class="fas fa-ruler-combined"></i> Fibonacci </div>
                        <div class="indicator-item" data-indicator="adx"> <i class="fas fa-street-view"></i> ADX </div>
                        <div class="indicator-item" data-indicator="vwap"> <i class="fas fa-balance-scale"></i> VWAP </div>
                        <div class="indicator-item" data-indicator="pivot"> <i class="fas fa-dot-circle"></i> Pivot Points </div>
                        <div class="indicator-item" data-indicator="atr"> <i class="fas fa-ruler"></i> ATR </div>
                        <div class="indicator-item" data-indicator="williams"> <i class="fas fa-percent"></i> Williams %R </div>
                        <div class="indicator-item" data-indicator="supertrend"> <i class="fas fa-arrow-trend-up"></i> Supertrend </div>
                    </div>
                </div>
                <button class="btn" id="analyze-btn"><i class="fas fa-bolt"></i> Generate AI Analysis</button>
                <div class="live-data-feed" style="margin-top: 25px;">
                    <h3 class="section-title"><i class="fas fa-calculator"></i> Company Matrices</h3>
                    <div class="control-metrics-grid" id="company-matrices-grid">
                        <!-- 14 cards will be dynamically inserted here by JS -->
                    </div>
                    <!-- Selected Indicators will be dynamically added here by JS -->
                </div>
            </div>
            
            <div class="output-panel">
                <div class="output-header">
                    <div class="stock-info">
                        <div class="stock-icon"><i class="fas fa-industry"></i></div>
                        <div class="stock-details"> 
                            <h2 id="stock-name-header">Select a Stock</h2> 
                            <p id="stock-price-header">Current Price: N/A</p> 
                        </div>
                    </div>
                    <div class="trend-indicator trend-neutral" id="stock-trend-indicator"><i class="fas fa-arrow-up"></i> Awaiting Data</div>
                </div>
                <div class="output-content">
                    <div class="analysis-section">
                        <h3 class="section-title"><i class="fas fa-brain"></i> AI Technical Summary</h3>
                        <p class="analysis-text" id="ai-technical-summary-main">Awaiting analysis...</p>
                        <div class="sentiment-meter" id="sentiment-meter-main">
                            <div class="sentiment-item sentiment-bullish"> <i class="fas fa-bullhorn"></i> <div>Bullish</div> </div>
                            <div class="sentiment-item sentiment-neutral active"> <i class="fas fa-pause-circle"></i> <div>Neutral</div> </div>
                            <div class="sentiment-item sentiment-bearish"> <i class="fas fa-bear"></i> <div>Bearish</div> </div>
                        </div>
                        <div class="confidence-meter"> 
                            <span>AI Confidence:</span> 
                            <div class="confidence-level"> <div class="confidence-fill" id="ai-confidence-bar"></div> </div> 
                            <span id="ai-confidence-text">N/A</span> 
                        </div>
                    </div>
                    <div class="analysis-section">
                        <h3 class="section-title"><i class="fas fa-chess-board"></i> AI Trade Strategy</h3>
                        <p class="analysis-text" id="ai-trade-recommendation">Awaiting analysis...</p>
                        <div class="strategy-cards" id="strategy-cards-main">
                            <div class="strategy-card"> <i class="fas fa-long-arrow-alt-up"></i> <div>Long Position</div> </div>
                            <div class="strategy-card"> <i class="fas fa-long-arrow-alt-down"></i> <div>Short Position</div> </div>
                            <div class="strategy-card"> <i class="fas fa-exchange-alt"></i> <div>Hedged Position</div> </div>
                        </div>
                        <div class="parameters">
                            <div class="param-card"> <div class="param-label">Entry Price</div> <div class="param-value" id="param-entry">N/A</div> </div>
                            <div class="param-card"> <div class="param-label">Stop Loss</div> <div class="param-value" id="param-sl">N/A</div> </div>
                            <div class="param-card"> <div class="param-label">Take Profit 1</div> <div class="param-value" id="param-tp1">N/A</div> </div>
                            <div class="param-card"> <div class="param-label">Take Profit 2</div> <div class="param-value" id="param-tp2">N/A</div> </div>
                        </div>
                    </div>
                    <div class="market-matrices">
                        <h3 class="section-title"><i class="fas fa-calculator"></i> Technical Matrices</h3>
                        <div class="matrices-grid" id="technical-matrices-grid">
                           <!-- 12 cards will be dynamically inserted here by JS -->
                        </div>
                    </div>
                    <div class="analysis-section thought-process">
                        <h3 class="section-title"><i class="fas fa-lightbulb"></i> AI Thought Process</h3>
                        <div class="thought-content" id="thought-content-main"><p class="analysis-text">Awaiting analysis...</p></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="ai-insights-section">
            <div class="analysis-section">
                <h3 class="section-title"><i class="fas fa-robot"></i> AI Predictive Insights</h3>
                <div class="insights-grid">
                    <div class="insight-card">
                        <h3 class="section-title"><i class="fas fa-chart-line"></i> Momentum Forecast</h3>
                        <p class="analysis-text" id="pi-momentum-text">Awaiting analysis...</p>
                        <div class="probability-meter"><div class="probability-fill" id="pi-momentum-bar" style="width: 0%"></div></div>
                        <div class="probability-value" id="pi-momentum-prob">N/A</div>
                    </div>
                    <div class="insight-card">
                        <h3 class="section-title"><i class="fas fa-project-diagram"></i> Market Sentiment & Risk</h3>
                        <p class="analysis-text" id="pi-sentiment-text">Awaiting analysis...</p>
                        <div class="risk-indicator" id="pi-risk-indicator">
                            <i class="fas fa-exclamation-triangle"></i><div id="pi-risk-label">Risk Level: N/A</div>
                            <div class="risk-bar"><div class="risk-level" id="pi-risk-bar" style="width: 50%;"></div></div>
                        </div>
                    </div>
                    <div class="insight-card">
                        <h3 class="section-title"><i class="fas fa-bullseye"></i> AI Price Targets</h3>
                        <p class="analysis-text">AI-generated price targets for multiple horizons.</p>
                        <div class="price-targets">
                            <div class="target-card"> <div class="target-label">Short-term</div> <div class="target-value" id="pi-target-short">N/A</div></div>
                            <div class="target-card"> <div class="target-label">Medium-term</div> <div class="target-value" id="pi-target-medium">N/A</div></div>
                            <div class="target-card"> <div class="target-label">Long-term</div> <div class="target-value" id="pi-target-long">N/A</div></div>
                            <div class="target-card"> <div class="target-label">Downside Risk</div> <div class="target-value" id="pi-target-downside">N/A</div></div>
                        </div>
                    </div>
                    <div class="insight-card">
                        <h3 class="section-title"><i class="fas fa-shield-alt"></i> Key Risk Assessment</h3>
                        <p class="analysis-text">Top risk factors identified by the AI model.</p>
                        <ul class="analysis-text" id="pi-risk-factors" style="margin-left: 20px; margin-top: 10px;"><li>Awaiting analysis...</li></ul>
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>StockSense Pro | Analysis generated at <span id="current-time"></span></p>
            <p>Note: This analysis is for informational purposes only. Trading involves risk.</p>
        </footer>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const setContent = (id, value, fallback = 'N/A') => { const el = document.getElementById(id); if (el) el.innerHTML = value || fallback; };
        const formatCurrency = (num) => (num === null || isNaN(num)) ? 'N/A' : num.toLocaleString('en-IN', { style: 'currency', currency: 'INR' });
        const formatNumber = (num, dec = 2) => (num === null || isNaN(num)) ? 'N/A' : num.toFixed(dec);
        const formatLargeNum = (num) => { if (num === null || isNaN(num)) return 'N/A'; if (num >= 1e12) return `₹${(num / 1e12).toFixed(2)}T`; if (num >= 1e7) return `₹${(num / 1e7).toFixed(2)}Cr`; return `₹${(num / 1e5).toFixed(2)}L`; };
        const showNotification = (message, isError = false) => { const el = document.createElement('div'); el.className = `notification ${isError ? 'error' : ''}`; el.innerHTML = `<i class="fas ${isError ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> ${message}`; document.body.appendChild(el); setTimeout(() => el.classList.add('show'), 10); setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 500); }, 5000); };
        const safeGet = (obj, path, fallback = null) => path.split('.').reduce((acc, part) => acc && acc[part] != null ? acc[part] : fallback, obj);

        const updateUI = (data) => {
            window.currentData = data;
            updateHeader(data);
            updateCompanyMatrices(data, safeGet(data, 'ai_analysis.conceptual_matrices'));
            updateTechnicalMatrices(data.all_indicators);
            updateSelectedIndicators();

            const ai = data.ai_analysis;
            if (ai && !ai.error) {
                let strategicText = (ai.strategic_outlook || '').replace(/\n/g, '<br>').replace(/\* (.*?)(?=<br>|\* |$)/g, '<li>$1</li>');
                setContent('gemini-strategic-outlook', `<p>${strategicText.includes('<li>') ? `<ul>${strategicText}</ul>` : strategicText}</p>`);
                let tacticalText = (ai.tactical_analysis || '').replace(/\n/g, '<br>').replace(/\* (.*?)(?=<br>|\* |$)/g, '<li>$1</li>');
                setContent('gemini-tactical-analysis', `<p>${tacticalText.includes('<li>') ? `<ul>${tacticalText}</ul>` : tacticalText}</p>`);
                
                updateAITechnicalSummary(ai);
                updateTradeStrategy(ai.trade_strategy);
                updateThoughtProcess(ai.thought_process);
                updatePredictiveInsights(ai.predictive_insights);
            } else {
                const errorMsg = ai ? ai.error : "AI analysis could not be generated.";
                showNotification(errorMsg, true);
                resetAISections(errorMsg);
            }
        };
        
        const createCard = (label, value) => `<div class="metric-card"><div class="metric-label">${label}</div><div class="metric-value">${value}</div></div>`;
        const createTechCard = (label, value) => `<div class="matrix-card"><div class="matrix-label">${label}</div><div class="matrix-value">${value}</div></div>`;

        const updateHeader = (data) => {
            setContent('stock-name-header', data.name || 'N/A');
            document.getElementById('stock-price-header').textContent = `Current Price: ${formatCurrency(data.price)} | 1d Change: ${formatNumber(data.change)}%`;
            const trend = document.getElementById('stock-trend-indicator');
            trend.className = 'trend-indicator';
            if (data.change > 1) { trend.classList.add('trend-up'); trend.innerHTML = `<i class="fas fa-arrow-up"></i> Bullish`; }
            else if (data.change < -1) { trend.classList.add('trend-down'); trend.innerHTML = `<i class="fas fa-arrow-down"></i> Bearish`; }
            else { trend.classList.add('trend-neutral'); trend.innerHTML = `<i class="fas fa-pause"></i> Neutral`; }
        };
        
        const updateCompanyMatrices = (data, aiMatrices) => {
            const grid = document.getElementById('company-matrices-grid');
            let content = createCard('Market Cap', formatLargeNum(data.marketCap));
            content += createCard('Volume', formatLargeNum(data.volume));
            content += createCard('52w High', formatCurrency(data.high52).replace('₹',''));
            content += createCard('52w Low', formatCurrency(data.low52).replace('₹',''));
            content += createCard('P/E Ratio', formatNumber(data.pe));
            content += createCard('Div Yield', `${formatNumber(data.divYield)}%`);
            const change1dClass = data.change >= 0 ? 'metric-positive' : 'metric-negative';
            content += `<div class="metric-card"><div class="metric-label">1d Change</div><div class="metric-value ${change1dClass}">${data.change >= 0 ? '+' : ''}${formatNumber(data.change)}%</div></div>`;
            const change1mClass = data.change_1m >= 0 ? 'metric-positive' : 'metric-negative';
            content += `<div class="metric-card"><div class="metric-label">1m Change</div><div class="metric-value ${change1mClass}">${data.change_1m >= 0 ? '+' : ''}${formatNumber(data.change_1m)}%</div></div>`;
            content += createCard('Beta', formatNumber(data.beta));
            content += createCard('RSI', formatNumber(data.all_indicators.rsi));
            content += createCard('Profit Prob.', safeGet(aiMatrices, 'profit_probability', 'N/A'));
            content += createCard('Risk/Reward', safeGet(aiMatrices, 'risk_reward_ratio', 'N/A'));
            content += createCard('AI Accuracy', safeGet(aiMatrices, 'historical_accuracy', 'N/A'));
            content += createCard('Volatility', safeGet(aiMatrices, 'volatility', 'N/A'));
            grid.innerHTML = content;
        };

        const updateTechnicalMatrices = (indicators) => {
            const grid = document.getElementById('technical-matrices-grid');
            let content = createTechCard('RSI (14)', formatNumber(indicators.rsi));
            content += createTechCard('SMA 50', formatCurrency(indicators.sma50).replace('₹',''));
            content += createTechCard('SMA 100', formatCurrency(indicators.sma100).replace('₹',''));
            content += createTechCard('Stoch RSI %K', formatNumber(indicators.stochrsi_k));
            content += createTechCard('Stoch RSI %D', formatNumber(indicators.stochrsi_d));
            content += createTechCard('Pivot Point', formatCurrency(indicators.pivot).replace('₹',''));
            content += createTechCard('R1 / S1', `${formatNumber(indicators.r1)} / ${formatNumber(indicators.s1)}`);
            content += createTechCard('R2 / S2', `${formatNumber(indicators.r2)} / ${formatNumber(indicators.s2)}`);
            content += createTechCard('ATR (14)', formatNumber(indicators.atr, 4));
            content += createTechCard('ADX', formatNumber(indicators.adx));
            content += createTechCard('VWAP', formatCurrency(indicators.vwap).replace('₹',''));
            content += createTechCard('OBV', formatLargeNum(indicators.obv).replace('₹',''));
            grid.innerHTML = content;
        };
        
        const updateSelectedIndicators = () => {
            const container = document.querySelector('.live-data-feed');
            let section = container.querySelector('.selected-indicators-section');
            if (!section) {
                section = document.createElement('div'); section.className = 'selected-indicators-section';
                section.innerHTML = `<h3 class="section-title" style="margin-top: 20px;"><i class="fas fa-tachometer-alt"></i> Selected Indicator Values</h3><div class="control-metrics-grid" id="selected-indicators-grid"></div>`;
                container.appendChild(section);
            }
            const grid = document.getElementById('selected-indicators-grid'); grid.innerHTML = '';
            
            if (!window.currentData || !window.currentData.all_indicators) { grid.innerHTML = `<p class="analysis-text" style="grid-column: 1/-1;">Indicator data unavailable.</p>`; return; }
            const allIndicators = window.currentData.all_indicators;
            const selected = document.querySelectorAll('.indicator-item.selected');
            if (selected.length === 0) { grid.innerHTML = `<p class="analysis-text" style="grid-column: 1/-1;">Select indicators to see values.</p>`; return; }
            selected.forEach(item => {
                const key = item.dataset.indicator; let value = 'N/A'; let label = item.textContent.trim();
                const formatters = {
                    'rsi': () => formatNumber(allIndicators.rsi), 'macd': () => formatNumber(allIndicators.macd_hist, 4), 'sma': () => formatCurrency(allIndicators.sma50).replace('₹',''), 'ema': () => formatCurrency(allIndicators.ema).replace('₹',''), 
                    'bollinger': () => `L:${formatNumber(allIndicators.bb_lower)} U:${formatNumber(allIndicators.bb_upper)}`, 'stochrsi': () => `K:${formatNumber(allIndicators.stochrsi_k)} D:${formatNumber(allIndicators.stochrsi_d)}`,
                    'obv': () => formatLargeNum(allIndicators.obv).replace('₹',''), 'adx': () => formatNumber(allIndicators.adx), 'vwap': () => formatCurrency(allIndicators.vwap).replace('₹',''),
                    'pivot': () => formatCurrency(allIndicators.pivot).replace('₹',''), 'atr': () => formatNumber(allIndicators.atr, 4),
                    'fibonacci': () => `L:${formatNumber(allIndicators.fib_low)} H:${formatNumber(allIndicators.fib_high)}`, 'williams': () => formatNumber(allIndicators.williams),
                    'supertrend': () => `${allIndicators.supertrend_dir > 0 ? 'Up' : 'Down'} at ${formatNumber(allIndicators.supertrend_val)}`
                };
                if(formatters[key]) value = formatters[key]();
                grid.innerHTML += `<div class="metric-card"><div class="metric-label">${label}</div><div class="metric-value" style="font-size: 1rem;">${value}</div></div>`;
            });
        };
        
        const updateAITechnicalSummary = (ai) => {
            setContent('ai-technical-summary-main', `<p>${(ai.tactical_analysis || 'N/A').replace(/\n/g, '<br>')}</p>`);
            const confidence = parseInt(safeGet(ai, 'predictive_insights.momentum_forecast.probability', 0));
            document.getElementById('ai-confidence-bar').style.width = `${confidence}%`;
            setContent('ai-confidence-text', `${confidence}%`);
            const meter = document.getElementById('sentiment-meter-main'); const items = meter.querySelectorAll('.sentiment-item');
            items.forEach(item => item.classList.remove('active'));
            const text = (ai.tactical_analysis || '').toLowerCase();
            if (text.includes('bullish') || text.includes('upward') || text.includes('strong')) meter.querySelector('.sentiment-bullish').classList.add('active');
            else if (text.includes('bearish') || text.includes('downward') || text.includes('weak')) meter.querySelector('.sentiment-bearish').classList.add('active');
            else meter.querySelector('.sentiment-neutral').classList.add('active');
        };

        const updateTradeStrategy = (strategy) => {
            setContent('ai-trade-recommendation', `Recommended strategy: <span class="bullish">${safeGet(strategy, 'recommendation', 'N/A')}</span>`);
            setContent('param-entry', formatCurrency(safeGet(strategy, 'entry')).replace('₹',''));
            setContent('param-sl', formatCurrency(safeGet(strategy, 'stop_loss')).replace('₹',''));
            setContent('param-tp1', formatCurrency(safeGet(strategy, 'tp1')).replace('₹',''));
            setContent('param-tp2', formatCurrency(safeGet(strategy, 'tp2')).replace('₹',''));
            const cards = document.getElementById('strategy-cards-main').querySelectorAll('.strategy-card');
            cards.forEach(card => card.classList.remove('active'));
            const text = (safeGet(strategy, 'recommendation', '')).toLowerCase();
            if (text.includes('long') || text.includes('buy')) cards[0].classList.add('active');
            else if (text.includes('short') || text.includes('sell')) cards[1].classList.add('active');
            else cards[2].classList.add('active');
        };

        const updateThoughtProcess = (thoughts) => {
            const container = document.getElementById('thought-content-main'); container.innerHTML = '';
            if (thoughts && thoughts.length > 0) {
                const col1 = document.createElement('div'); col1.className = 'thought-column';
                const col2 = document.createElement('div'); col2.className = 'thought-column';
                const icons = ['fa-chart-line', 'fa-layer-group', 'fa-chart-bar', 'fa-bullseye', 'fa-cloud', 'fa-users'];
                thoughts.forEach((thought, i) => {
                    const item = document.createElement('div'); item.className = 'thought-item';
                    item.innerHTML = `<div class="thought-icon"><i class="fas ${icons[i % icons.length]}"></i></div><div>${thought}</div>`;
                    (i < Math.ceil(thoughts.length / 2) ? col1 : col2).appendChild(item);
                });
                container.appendChild(col1); container.appendChild(col2);
            } else { container.innerHTML = '<p class="analysis-text">AI thought process not available.</p>'; }
        };

        const updatePredictiveInsights = (pi) => {
            const prob = parseInt(safeGet(pi, 'momentum_forecast.probability', 0));
            setContent('pi-momentum-text', safeGet(pi, 'momentum_forecast.text', 'Awaiting...'));
            document.getElementById('pi-momentum-bar').style.width = `${prob}%`;
            setContent('pi-momentum-prob', `${prob}%`);
            
            setContent('pi-sentiment-text', safeGet(pi, 'market_sentiment.text', 'Awaiting...'));
            const riskLevel = safeGet(pi, 'market_sentiment.risk_level', 'medium').toLowerCase();
            const indicator = document.getElementById('pi-risk-indicator');
            indicator.className = `risk-indicator risk-${riskLevel}`;
            document.getElementById('pi-risk-label').textContent = `Risk Level: ${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)}`;
            document.getElementById('pi-risk-bar').style.width = riskLevel === 'low' ? '25%' : riskLevel === 'medium' ? '50%' : '85%';

            setContent('pi-target-short', formatCurrency(safeGet(pi, 'price_targets.short_term')));
            setContent('pi-target-medium', formatCurrency(safeGet(pi, 'price_targets.medium_term')));
            setContent('pi-target-long', formatCurrency(safeGet(pi, 'price_targets.long_term')));
            setContent('pi-target-downside', formatCurrency(safeGet(pi, 'price_targets.downside_risk')));
            
            const factors = safeGet(pi, 'risk_assessment.factors', []);
            setContent('pi-risk-factors', factors.length > 0 ? factors.map(f => `<li>${f}</li>`).join('') : '<li>Awaiting...</li>');
        };

        const resetAISections = (message) => {
            const errorHtml = `<p class="analysis-text error-message">${message}</p>`;
            setContent('gemini-strategic-outlook', errorHtml); setContent('gemini-tactical-analysis', errorHtml);
            updatePredictiveInsights({});
        };

        const analyzeBtn = document.getElementById('analyze-btn');
        const indicatorList = document.getElementById('indicator-list');
        window.currentData = null;

        analyzeBtn.addEventListener('click', async function() {
            const stockSymbol = document.getElementById('stock-select').value;
            const riskTolerance = document.getElementById('risk-level').value;
            const timeframe = document.getElementById('timeframe').value;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...'; this.disabled = true;
            try {
                const response = await fetch('/analyze', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ stock: stockSymbol, risk: riskTolerance, timeframe: timeframe })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || `Server error: ${response.status}`);
                updateUI(data);
                showNotification(`Analysis complete for ${stockSymbol}`);
            } catch (error) {
                console.error('Analysis Error:', error); showNotification(error.message, true); resetAISections(error.message);
            } finally {
                this.innerHTML = '<i class="fas fa-bolt"></i> Generate AI Analysis'; this.disabled = false;
            }
        });

        indicatorList.addEventListener('click', (e) => {
            const item = e.target.closest('.indicator-item');
            if (item) { item.classList.toggle('selected'); if (window.currentData) updateSelectedIndicators(); }
        });
        
        if (document.getElementById('stock-select').value) analyzeBtn.click();
        setInterval(() => setContent('current-time', new Date().toLocaleString('en-IN', { dateStyle: 'full', timeStyle: 'medium' })), 1000);
    });
    </script>
</body>
</html>